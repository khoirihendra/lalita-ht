<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>LALITA Interactive Catalog</title>
    <link rel="icon" type="image/x-icon"
        href="https://lh3.googleusercontent.com/pw/AP1GczPGhK4Bsqs7ATtNxHUJDaRYq39w8kJLQ9NgoMGaXgKSHpm9-kXo7yC68x3FTU5Ip7pPXzTAd7LPcSUVLukGYOOkCmrKMvGeirpwr-a7OVRQMIBuA1yF89Kk0n6LGDH48CUuF8dqEWsXNfyuvalLVefP=w913-h913-s-no-gm?authuser=0">
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap"
        rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#ce1126",
                        "background-light": "#f6f6f8",
                        "background-dark": "#101622",
                        "surface-dark": "#1a2436",
                        "surface-darker": "#151c2a",
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"]
                    },
                    borderRadius: {
                        "DEFAULT": "0.25rem",
                        "lg": "0.5rem",
                        "xl": "0.75rem",
                        "2xl": "1rem",
                        "full": "9999px"
                    },
                },
            },
        }
    </script>
    <style>
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Three.js Canvas Fix */
        #canvas-container canvas {
            display: block;
            width: 100% !important;
            height: 100% !important;
            outline: none;
        }
    </style>
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
            }
        }
    </script>
</head>

<body
    class="bg-background-light dark:bg-background-dark text-slate-900 dark:text-white font-display h-screen flex flex-col overflow-hidden">

    <!-- HEADER -->
    <header
        class="flex shrink-0 items-center justify-between whitespace-nowrap border-b border-solid border-slate-200 dark:border-[#232f48] px-6 py-4 bg-white dark:bg-[#111722] z-20">
        <div class="flex items-center gap-4 text-slate-900 dark:text-white">
            <div class="size-10 text-primary flex items-center justify-center bg-primary/10 rounded-lg shrink-0">
                <span class="material-symbols-outlined !text-[28px]">museum</span>
            </div>
            <div class="flex flex-col">
                <h2 id="app-title-text"
                    class="text-slate-900 dark:text-white text-lg font-bold leading-tight tracking-tight uppercase">
                    LALITA Interactive Catalog</h2>
                <p class="text-xs text-slate-500 dark:text-slate-400 font-medium mt-0.5">Library of Archaeological
                    Legacies and Iconographic Treasures of Ancient Java</p>
            </div>
        </div>
        <div class="flex flex-1 justify-end gap-6 items-center">
            <div class="flex items-center gap-2">
                <div class="bg-slate-100 dark:bg-[#232f48] p-1 rounded-lg flex items-center">
                    <button id="btn-lang-en"
                        class="px-3 py-1 rounded-md text-xs font-medium text-slate-500 dark:text-slate-400 hover:text-slate-900 dark:hover:text-white transition-all">EN</button>
                    <button id="btn-lang-id"
                        class="px-3 py-1 rounded-md bg-white dark:bg-[#111722] shadow-sm text-xs font-bold text-primary transition-all">ID</button>
                </div>
            </div>
            <div class="w-px h-6 bg-slate-200 dark:bg-[#232f48]"></div>
            <button id="btn-theme-toggle"
                class="group flex items-center justify-center size-9 rounded-lg text-slate-500 hover:bg-slate-100 dark:text-slate-400 dark:hover:bg-[#232f48] transition-colors"
                title="Toggle theme">
                <span class="material-symbols-outlined group-hover:text-primary transition-colors">light_mode</span>
            </button>
        </div>
    </header>

    <main class="flex flex-1 overflow-hidden relative">
        <!-- LEFT SIDEBAR -->
        <aside
            class="w-72 shrink-0 border-r border-slate-200 dark:border-[#232f48] flex flex-col bg-white dark:bg-[#111722] z-10">
            <div class="flex flex-col border-b border-slate-200 dark:border-[#232f48]">
                <div class="px-4 pt-4 pb-2">
                    <h3 id="sidebar-title"
                        class="text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-[#92a4c9]">
                        Model List</h3>
                </div>
                <div class="px-4 pb-4">
                    <div
                        class="flex w-full items-center rounded-lg bg-slate-100 dark:bg-[#1a2436] focus-within:ring-2 focus-within:ring-primary/50 transition-all border border-transparent focus-within:border-primary/20">
                        <div class="text-slate-400 dark:text-[#92a4c9] flex items-center justify-center pl-3">
                            <span class="material-symbols-outlined text-[20px]">search</span>
                        </div>
                        <input id="search-input"
                            class="w-full bg-transparent border-none text-slate-900 dark:text-white placeholder:text-slate-400 dark:placeholder:text-[#92a4c9] px-3 py-2 text-sm focus:outline-none focus:ring-0"
                            placeholder="Search..." />
                    </div>
                </div>
            </div>

            <!-- LIST CONTAINER -->
            <div class="flex-1 overflow-y-auto custom-scrollbar p-2 flex flex-col gap-1 relative">
                <div id="file-list-status" class="hidden text-center text-xs p-4 text-slate-500"></div>
                <ul id="file-list" class="flex flex-col gap-1">
                    <!-- Javascript will populate this -->
                </ul>
            </div>
        </aside>

        <!-- MAIN CONTENT AREA -->
        <div class="flex-1 flex flex-col h-full overflow-y-auto custom-scrollbar bg-slate-50 dark:bg-black/20 relative">

            <!-- 3D VIEWER CONTAINER -->
            <div id="canvas-container"
                class="h-[55vh] min-h-[400px] shrink-0 relative w-full bg-[#151c2a] flex items-center justify-center overflow-hidden group">
                <!-- Three.js Canvas will be appended here -->

                <!-- Loading Overlay -->
                <div id="loading-overlay"
                    class="hidden absolute inset-0 bg-background-dark/80 z-20 flex items-center justify-center flex-col gap-2">
                    <span class="material-symbols-outlined animate-spin text-primary text-4xl">progress_activity</span>
                    <div id="loading-text" class="text-primary font-bold animate-pulse text-lg">Loading Model...</div>
                </div>

                <!-- Status Message Toast -->
                <div id="view-status-message"
                    class="absolute top-4 left-1/2 -translate-x-1/2 px-4 py-2 rounded-full bg-black/50 backdrop-blur text-white text-xs font-medium opacity-0 transition-opacity duration-300 pointer-events-none z-30">
                </div>

                <!-- Controls Overlay (Visual Only for now, mapped later potentially) -->
                <div
                    class="absolute bottom-6 left-1/2 -translate-x-1/2 flex gap-2 bg-black/60 backdrop-blur-md rounded-full p-2 border border-white/10 opacity-0 group-hover:opacity-100 transition-opacity duration-300 z-10">
                    <button id="btn-rotate-left"
                        class="size-8 rounded-full hover:bg-white/20 flex items-center justify-center text-white"
                        title="Rotate Left (Mock)">
                        <span class="material-symbols-outlined text-lg">rotate_left</span>
                    </button>
                    <button id="btn-zoom-in"
                        class="size-8 rounded-full hover:bg-white/20 flex items-center justify-center text-white"
                        title="Zoom In (Mock)">
                        <span class="material-symbols-outlined text-lg">zoom_in</span>
                    </button>
                    <button id="btn-zoom-out"
                        class="size-8 rounded-full hover:bg-white/20 flex items-center justify-center text-white"
                        title="Zoom Out (Mock)">
                        <span class="material-symbols-outlined text-lg">zoom_out</span>
                    </button>
                    <button id="btn-rotate-right"
                        class="size-8 rounded-full hover:bg-white/20 flex items-center justify-center text-white"
                        title="Rotate Right (Mock)">
                        <span class="material-symbols-outlined text-lg">rotate_right</span>
                    </button>
                    <div class="w-px h-6 bg-white/20 mx-1 self-center"></div>
                    <button id="btn-fullscreen"
                        class="size-8 rounded-full hover:bg-white/20 flex items-center justify-center text-white"
                        title="Fullscreen (Mock)">
                        <span class="material-symbols-outlined text-lg">fullscreen</span>
                    </button>
                </div>
            </div>

            <!-- DESCRIPTION PANEL -->
            <div
                class="bg-white dark:bg-[#111722] border-t border-slate-200 dark:border-[#232f48] p-8 shrink-0 min-h-[200px]">
                <div class="max-w-4xl mx-auto flex flex-col gap-6">


                    <!-- Stats Grid -->
                    <div id="stats-container" class="grid grid-cols-2 md:grid-cols-3 gap-3">
                        <!-- Populated by JS -->
                    </div>

                    <!-- Description Text -->
                    <div id="description-container"
                        class="bg-slate-50 dark:bg-[#1a2436] rounded-xl p-6 border border-slate-100 dark:border-slate-700/50">
                        <h3
                            class="text-xs font-bold uppercase tracking-wider text-slate-400 dark:text-slate-500 mb-3 flex items-center gap-2">
                            <span class="material-symbols-outlined text-sm">description</span> <span
                                id="label-description">Description</span>
                        </h3>
                        <div id="object-description"
                            class="text-slate-600 dark:text-slate-300 leading-relaxed text-sm text-justify font-sans">
                            Please load an .obj file from the list.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- RIGHT SIDEBAR (OPTIONS) -->
        <aside
            class="w-72 shrink-0 border-l border-slate-200 dark:border-[#232f48] flex flex-col bg-white dark:bg-[#111722] z-10 overflow-y-auto custom-scrollbar">
            <div class="p-5 border-b border-slate-200 dark:border-[#232f48]">
                <h3 class="text-sm font-semibold text-slate-900 dark:text-white flex items-center gap-2">
                    <span class="material-symbols-outlined text-primary">tune</span>
                    <span id="label-render-options">Rendering Options</span>
                </h3>
            </div>
            <div class="p-5 flex flex-col gap-8">

                <!-- VIEW MODE -->
                <div>
                    <h4 id="label-view-mode"
                        class="text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-[#92a4c9] mb-3">
                        View Mode</h4>
                    <div class="flex flex-col gap-2">
                        <label
                            class="group relative flex cursor-pointer items-center justify-between rounded-lg border border-slate-200 dark:border-[#324467] bg-white dark:bg-[#1a2436] p-3 hover:border-slate-300 dark:hover:border-slate-500 transition-all has-[:checked]:border-primary has-[:checked]:bg-primary/5">
                            <div class="flex items-center gap-3">
                                <span
                                    class="flex size-8 items-center justify-center rounded-md bg-slate-100 dark:bg-[#232f48] text-slate-500 dark:text-slate-300 group-has-[:checked]:bg-primary group-has-[:checked]:text-white transition-colors">
                                    <span class="material-symbols-outlined text-lg">contrast</span>
                                </span>
                                <span
                                    class="text-sm font-medium text-slate-600 dark:text-slate-300 group-has-[:checked]:text-slate-900 dark:group-has-[:checked]:text-white"
                                    id="label-detail">Detail</span>
                            </div>
                            <input type="radio" name="material" value="detail" checked
                                class="peer size-4 text-primary focus:ring-primary/20 bg-slate-100 dark:bg-slate-700 border-slate-300 dark:border-slate-600" />
                        </label>

                        <label
                            class="group relative flex cursor-pointer items-center justify-between rounded-lg border border-slate-200 dark:border-[#324467] bg-white dark:bg-[#1a2436] p-3 hover:border-slate-300 dark:hover:border-slate-500 transition-all has-[:checked]:border-primary has-[:checked]:bg-primary/5">
                            <div class="flex items-center gap-3">
                                <span
                                    class="flex size-8 items-center justify-center rounded-md bg-slate-100 dark:bg-[#232f48] text-slate-500 dark:text-slate-300 group-has-[:checked]:bg-primary group-has-[:checked]:text-white transition-colors">
                                    <span class="material-symbols-outlined text-lg">light_mode</span>
                                </span>
                                <span
                                    class="text-sm font-medium text-slate-600 dark:text-slate-300 group-has-[:checked]:text-slate-900 dark:group-has-[:checked]:text-white"
                                    id="label-shaded">Shaded</span>
                            </div>
                            <input type="radio" name="material" value="shaded"
                                class="peer size-4 text-primary focus:ring-primary/20 bg-slate-100 dark:bg-slate-700 border-slate-300 dark:border-slate-600" />
                        </label>

                        <label
                            class="group relative flex cursor-pointer items-center justify-between rounded-lg border border-slate-200 dark:border-[#324467] bg-white dark:bg-[#1a2436] p-3 hover:border-slate-300 dark:hover:border-slate-500 transition-all has-[:checked]:border-primary has-[:checked]:bg-primary/5">
                            <div class="flex items-center gap-3">
                                <span
                                    class="flex size-8 items-center justify-center rounded-md bg-slate-100 dark:bg-[#232f48] text-slate-500 dark:text-slate-300 group-has-[:checked]:bg-primary group-has-[:checked]:text-white transition-colors">
                                    <span class="material-symbols-outlined text-lg">image</span>
                                </span>
                                <span
                                    class="text-sm font-medium text-slate-600 dark:text-slate-300 group-has-[:checked]:text-slate-900 dark:group-has-[:checked]:text-white"
                                    id="label-original">Original</span>
                            </div>
                            <input type="radio" name="material" value="original"
                                class="peer size-4 text-primary focus:ring-primary/20 bg-slate-100 dark:bg-slate-700 border-slate-300 dark:border-slate-600" />
                        </label>
                    </div>
                </div>

                <div class="w-full h-px bg-slate-200 dark:bg-[#232f48]"></div>

                <!-- MESH DISPLAY -->
                <div>
                    <h4 id="label-mesh-display"
                        class="text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-[#92a4c9] mb-3">
                        Mesh Display</h4>
                    <div class="grid grid-cols-2 gap-3">
                        <label class="cursor-pointer group">
                            <input type="radio" name="mesh" value="solid" checked class="peer sr-only" />
                            <div
                                class="flex flex-col items-center justify-center rounded-lg border border-slate-200 dark:border-[#324467] bg-white dark:bg-[#1a2436] p-3 text-center transition-all peer-checked:border-primary peer-checked:bg-primary/5 peer-checked:text-primary hover:bg-slate-50 dark:hover:bg-[#232f48]">
                                <span
                                    class="material-symbols-outlined mb-1 group-hover:scale-110 transition-transform">view_in_ar</span>
                                <span class="text-xs font-medium" id="label-solid">Solid</span>
                            </div>
                        </label>
                        <label class="cursor-pointer group">
                            <input type="radio" name="mesh" value="wireframe" class="peer sr-only" />
                            <div
                                class="flex flex-col items-center justify-center rounded-lg border border-slate-200 dark:border-[#324467] bg-white dark:bg-[#1a2436] p-3 text-center transition-all peer-checked:border-primary peer-checked:bg-primary/5 peer-checked:text-primary hover:bg-slate-50 dark:hover:bg-[#232f48]">
                                <span
                                    class="material-symbols-outlined mb-1 group-hover:scale-110 transition-transform">grid_4x4</span>
                                <span class="text-xs font-medium" id="label-wireframe">Wireframe</span>
                            </div>
                        </label>
                    </div>
                </div>
            </div>
        </aside>
    </main>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { OBJLoader } from 'three/addons/loaders/OBJLoader.js';
        import { MTLLoader } from 'three/addons/loaders/MTLLoader.js';

        const API_KEY = '5a454a48-7efd-45b9-a080-33d0b9cc44c1';
        const BASE_URL = 'https://data.brin.go.id';
        const DATASET_PID = 'hdl:20.500.12690/RIN/FRQUET';

        // --- GLOBAL UI STRINGS ---
        const UI_STRINGS = {
            id: {
                appTitle: "LALITA Interactive Catalog",
                sidebarTitle: "Daftar Model",
                filesFoundLabel: "File Ditemukan:",
                repoLoading: "Mengambil data...",
                repoError: "Gagal memuat data",
                repoNoFiles: "Tidak ada file ditemukan",
                descPlaceholder: "Pilih model dari daftar sebelah kiri untuk melihat detail.",
                loading: "Memuat...",
                detailHeader: "Detail Objek",
                fieldName: "Nama File",
                fieldMeshes: "Jumlah Mesh",
                fieldVertices: "Total Vertex",
                fieldTriangles: "Total Segitiga",
                fieldMtlLoaded: "Data MTL",
                fieldTexLoaded: "Data Tekstur",
                statusYesMtl: "Ya",
                statusNoMtl: "Tidak",
                statusYesTex: "Ya",
                statusNoTex: "Tidak",
                labelRenderOptions: "Opsi Rendering",
                labelViewMode: "Mode Tampilan",
                labelDetail: "Detail (Normal)",
                labelShaded: "Shaded (Cahaya)",
                labelOriginal: "Original (Asli)",
                labelMeshDisplay: "Tampilan Mesh",
                labelSolid: "Padat",
                labelWireframe: "Kerangka",
                placeholderSearch: "Cari koleksi...",
                msgDetail: "Mode: Detail",
                msgShaded: "Mode: Shaded",
                msgOriginal: "Mode: Original",
                msgErrOriginal: "Tidak ada tekstur/MTL. Kembali ke Shaded.",
                labelDescription: "Deskripsi"
            },
            en: {
                appTitle: "LALITA Interactive Catalog",
                sidebarTitle: "Model List",
                filesFoundLabel: "Files Found:",
                repoLoading: "Fetching data...",
                repoError: "Failed to load data",
                repoNoFiles: "No files found",
                descPlaceholder: "Select a model from the list on the left to view details.",
                loading: "Loading...",
                detailHeader: "Object Details",
                fieldName: "File Name",
                fieldMeshes: "Meshes",
                fieldVertices: "Vertices",
                fieldTriangles: "Triangles",
                fieldMtlLoaded: "MTL Data",
                fieldTexLoaded: "Texture Data",
                statusYesMtl: "Yes",
                statusNoMtl: "No",
                statusYesTex: "Yes",
                statusNoTex: "No",
                labelRenderOptions: "Rendering Options",
                labelViewMode: "View Mode",
                labelDetail: "Detail (Normal)",
                labelShaded: "Shaded (Lit)",
                labelOriginal: "Original",
                labelMeshDisplay: "Mesh Display",
                labelSolid: "Solid",
                labelWireframe: "Wireframe",
                placeholderSearch: "Search collection...",
                msgDetail: "Mode: Detail",
                msgShaded: "Mode: Shaded",
                msgOriginal: "Mode: Original",
                msgErrOriginal: "No Texture/MTL found. Reverting to Shaded.",
                labelDescription: "Description"
            }
        };

        // --- GLOBAL VARIABLES ---
        let currentLang = 'id';
        let scene, camera, renderer, controls, loadedObject;
        let ambientLight, directionalLight;
        let loadedFileObjects = new Map();
        let currentFilter = "";

        // DOM Elements
        const canvasContainer = document.getElementById('canvas-container');
        const descriptionEl = document.getElementById('object-description');
        const fileListEl = document.getElementById('file-list');
        const fileListStatusEl = document.getElementById('file-list-status');
        const searchInput = document.getElementById('search-input');
        const loadingOverlay = document.getElementById('loading-overlay');
        const statusToast = document.getElementById('view-status-message');

        // Materials
        let originalMaterials = null;
        let customTexture = null;
        let customTexturedMaterial = null;
        let isWireframe = false;

        const normalMaterial = new THREE.MeshNormalMaterial();
        const shadedMaterial = new THREE.MeshStandardMaterial({
            color: 0x86efac,
            roughness: 0.7,
            metalness: 0.1
        });

        // --- INITIALIZATION ---
        async function init() {
            try {
                // Default Lang based on logic or localStorage could go here, defaulting to ID/EN
                switchLanguage('id');

                // Three.js Setup
                scene = new THREE.Scene();
                updateSceneBackground(); // Set initial background based on HTML class

                camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
                camera.position.set(5, 2, 5);

                renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
                renderer.setPixelRatio(window.devicePixelRatio);
                renderer.setSize(canvasContainer.clientWidth, canvasContainer.clientHeight);
                canvasContainer.appendChild(renderer.domElement);

                controls = new OrbitControls(camera, renderer.domElement);
                controls.enableDamping = true;
                controls.dampingFactor = 0.05;

                // Lights
                ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
                scene.add(ambientLight);
                directionalLight = new THREE.DirectionalLight(0xffffff, 1.5);
                directionalLight.position.set(5, 10, 7);
                scene.add(directionalLight);

                // Listeners
                window.addEventListener('resize', onWindowResize);

                // Language Buttons
                document.getElementById('btn-lang-en').addEventListener('click', () => switchLanguage('en'));
                document.getElementById('btn-lang-id').addEventListener('click', () => switchLanguage('id'));

                // Theme Toggle
                document.getElementById('btn-theme-toggle').addEventListener('click', toggleTheme);

                // Search
                searchInput.addEventListener('input', (e) => {
                    currentFilter = e.target.value.toLowerCase();
                    renderFileList();
                });

                // Radio Buttons (Delegation)
                document.querySelectorAll('input[name="material"]').forEach(radio => {
                    radio.addEventListener('change', () => updateObjectMaterial(true));
                });
                document.querySelectorAll('input[name="mesh"]').forEach(radio => {
                    radio.addEventListener('change', () => updateObjectMaterial(true));
                });

                // Canvas Controls
                const bindBtn = (id, fn) => {
                    const btn = document.getElementById(id);
                    if (btn) btn.addEventListener('click', fn);
                };
                bindBtn('btn-rotate-left', () => { if (loadedObject) loadedObject.rotation.y -= Math.PI / 8; });
                bindBtn('btn-rotate-right', () => { if (loadedObject) loadedObject.rotation.y += Math.PI / 8; });
                bindBtn('btn-zoom-in', () => camera.position.multiplyScalar(0.9));
                bindBtn('btn-zoom-out', () => camera.position.multiplyScalar(1.1));
                bindBtn('btn-fullscreen', () => {
                    if (!document.fullscreenElement) {
                        canvasContainer.requestFullscreen().catch(err => console.error(`Error attempting to enable fullscreen: ${err.message}`));
                    } else {
                        document.exitFullscreen();
                    }
                });

                animate();
                loadDataverseFiles();
            } catch (err) {
                console.error("Init Error:", err);
                if (fileListStatusEl) {
                    fileListStatusEl.classList.remove('hidden');
                    fileListStatusEl.innerHTML = `<span class="text-red-500 font-bold">Error Init: ${err.message}</span>`;
                }
            }
        }

        function switchLanguage(lang) {
            currentLang = lang;
            const strings = UI_STRINGS[lang];

            // Toggle Button Styles
            const btnEn = document.getElementById('btn-lang-en');
            const btnId = document.getElementById('btn-lang-id');
            const activeClass = ["bg-white", "dark:bg-[#111722]", "shadow-sm", "text-primary", "font-bold"];
            const inactiveClass = ["text-slate-500", "dark:text-slate-400", "font-medium"];

            if (lang === 'en') {
                btnEn.classList.add(...activeClass);
                btnEn.classList.remove(...inactiveClass);
                btnId.classList.remove(...activeClass);
                btnId.classList.add(...inactiveClass);
            } else {
                btnId.classList.add(...activeClass);
                btnId.classList.remove(...inactiveClass);
                btnEn.classList.remove(...activeClass);
                btnEn.classList.add(...inactiveClass);
            }

            // Text Updates
            document.getElementById('app-title-text').textContent = strings.appTitle;
            document.getElementById('sidebar-title').textContent = strings.sidebarTitle;
            document.getElementById('label-render-options').textContent = strings.labelRenderOptions;
            document.getElementById('label-view-mode').textContent = strings.labelViewMode;
            document.getElementById('label-detail').textContent = strings.labelDetail;
            document.getElementById('label-shaded').textContent = strings.labelShaded;
            document.getElementById('label-original').textContent = strings.labelOriginal;
            document.getElementById('label-mesh-display').textContent = strings.labelMeshDisplay;
            document.getElementById('label-solid').textContent = strings.labelSolid;
            document.getElementById('label-wireframe').textContent = strings.labelWireframe;
            document.getElementById('label-description').textContent = strings.labelDescription;

            searchInput.placeholder = strings.placeholderSearch;

            // Re-render description if obj loaded
            if (loadedObject) {
                updateDescription(loadedObject, loadedObject.name, loadedObject.descriptionText, null, loadedObject.textureDataURL);
            } else {
                descriptionEl.textContent = strings.descPlaceholder;
            }

            // Check list status
            if (loadedFileObjects.size === 0) setListStatus('loading');
        }

        function toggleTheme() {
            document.documentElement.classList.toggle('dark');
            updateSceneBackground();
        }

        function updateSceneBackground() {
            if (!scene) return;
            const isDark = document.documentElement.classList.contains('dark');
            // background-dark: #101622 (0x101622) or surface-darker #151c2a (0x151c2a) - matches container
            // background-light: #ffffff (White)
            scene.background = new THREE.Color(isDark ? 0x151c2a : 0xffffff);
        }

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }

        function onWindowResize() {
            if (!canvasContainer) return;
            const w = canvasContainer.clientWidth;
            const h = canvasContainer.clientHeight;
            camera.aspect = w / h;
            camera.updateProjectionMatrix();
            renderer.setSize(w, h);
        }

        function showToast(msg, isError = false) {
            statusToast.textContent = msg;
            statusToast.style.opacity = '1';
            statusToast.classList.toggle('text-red-400', isError);
            setTimeout(() => { statusToast.style.opacity = '0'; }, 3000);
        }

        // --- DATAVERSE LOGIC ---
        async function loadDataverseFiles() {
            setListStatus('loading');
            try {
                const response = await fetch(`${BASE_URL}/api/datasets/:persistentId/versions/:latest/files?persistentId=${DATASET_PID}`, { headers: { 'X-Dataverse-Key': API_KEY } });
                if (!response.ok) throw new Error("Network response was not ok");
                const json = await response.json();

                if (!json.data || json.data.length === 0) {
                    setListStatus('empty');
                    return;
                }

                const fileMap = new Map();
                json.data.forEach(item => {
                    const file = item.dataFile;
                    const filename = file.filename;
                    const lastDotIndex = filename.lastIndexOf('.');
                    if (lastDotIndex === -1) return;

                    const ext = filename.substring(lastDotIndex + 1).toLowerCase();
                    const baseName = filename.substring(0, lastDotIndex);

                    if (!fileMap.has(baseName)) fileMap.set(baseName, { objFile: null, txtFile: null, mtlFile: null, texFile: null });
                    const entry = fileMap.get(baseName);
                    const fileData = { id: file.id, filename: filename, contentType: file.contentType };

                    if (ext === 'obj') entry.objFile = fileData;
                    else if (ext === 'txt') entry.txtFile = fileData;
                    else if (ext === 'mtl') entry.mtlFile = fileData;
                    else if (['jpg', 'jpeg', 'png'].includes(ext)) entry.texFile = fileData;
                });

                loadedFileObjects.clear();
                fileMap.forEach((val, key) => {
                    if (val.objFile) loadedFileObjects.set(key, val);
                });

                if (loadedFileObjects.size === 0) setListStatus('empty');
                else {
                    setListStatus('ready');
                    renderFileList();
                }

            } catch (error) {
                console.error(error);
                setListStatus('error');
            }
        }

        function setListStatus(status) {
            const strings = UI_STRINGS[currentLang];
            fileListStatusEl.className = "text-center text-xs p-4 text-slate-500 italic"; // reset
            fileListStatusEl.classList.remove('hidden');

            if (status === 'loading') {
                fileListStatusEl.innerHTML = `<span class="material-symbols-outlined animate-spin text-sm">sync</span> ${strings.repoLoading}`;
            } else if (status === 'error') {
                fileListStatusEl.textContent = strings.repoError;
                fileListStatusEl.classList.add('text-red-500');
            } else if (status === 'empty') {
                fileListStatusEl.textContent = strings.repoNoFiles;
            } else {
                fileListStatusEl.classList.add('hidden');
            }
        }

        function renderFileList() {
            const strings = UI_STRINGS[currentLang];
            fileListEl.innerHTML = '';

            const keys = Array.from(loadedFileObjects.keys()).sort();
            const filtered = keys.filter(k => k.toLowerCase().includes(currentFilter));

            if (filtered.length === 0 && keys.length > 0) {
                fileListEl.innerHTML = `<li class="text-center text-xs text-slate-400 p-4">No match found.</li>`;
                return;
            }

            filtered.forEach(key => {
                const filePair = loadedFileObjects.get(key);
                const li = document.createElement('li');

                // Indicators logic
                let indicators = '';
                const hasInfo = !!filePair.txtFile;

                if (hasInfo) {
                    indicators = `
                     <span class="text-[10px] uppercase font-bold tracking-wide text-primary/80 flex items-center gap-1">
                        <span class="material-symbols-outlined text-[14px]">description</span> Info
                    </span>`;
                } else {
                    indicators = `
                     <span class="text-[10px] uppercase font-bold tracking-wide text-slate-300 dark:text-slate-700 opacity-50 flex items-center gap-1">
                        <span class="material-symbols-outlined text-[14px]">comments_disabled</span> No Info
                    </span>`;
                }

                // Create Button
                const btn = document.createElement('button');
                btn.className = "flex items-center justify-between p-3 rounded-md hover:bg-slate-100 dark:hover:bg-[#1a2436] text-slate-700 dark:text-slate-300 text-sm text-left group transition-all border-l-4 border-transparent hover:border-slate-300 dark:hover:border-slate-600 w-full";
                btn.innerHTML = `<span>${key}</span>${indicators}`;

                // Active State Check (simple check if loaded)
                if (loadedObject && loadedObject.name === filePair.objFile.filename) {
                    btn.classList.remove('hover:bg-slate-100', 'border-transparent');
                    btn.classList.add('bg-primary/10', 'text-primary', 'border-primary');
                }

                btn.onclick = () => loadSelectedFile(key);
                li.appendChild(btn);
                fileListEl.appendChild(li);
            });
        }

        async function loadSelectedFile(key) {
            const filePair = loadedFileObjects.get(key);
            if (!filePair) return;

            loadingOverlay.classList.remove('hidden');

            try {
                // ... (Existing loading logic adapted)
                await loadObjectAndDescription(filePair.objFile, filePair.txtFile, filePair.mtlFile, filePair.texFile);
            } catch (e) {
                console.error(e);
                showToast("Error loading file", true);
            } finally {
                loadingOverlay.classList.add('hidden');
                renderFileList(); // Re-render to update active state
            }
        }

        async function fetchDataverseFileContent(fileId, responseType = 'text') {
            const url = `${BASE_URL}/api/access/datafile/${fileId}`;
            const response = await fetch(url, { headers: { 'X-Dataverse-Key': API_KEY } });
            if (!response.ok) throw new Error(`Failed to fetch file. Status: ${response.status}`);
            return responseType === 'arraybuffer' ? response.arrayBuffer() : response.text();
        }

        async function loadObjectAndDescription(objFile, txtFile, mtlFile, texFile) {
            const strings = UI_STRINGS[currentLang];
            const fileName = objFile.filename;

            // Cleanup
            if (loadedObject) {
                scene.remove(loadedObject);
                // Dispose logic...
            }
            // Dispose textures
            if (customTexture) customTexture.dispose();
            loadedObject = null;
            originalMaterials = null;
            customTexture = null;
            customTexturedMaterial = null;

            const objContent = await fetchDataverseFileContent(objFile.id, 'text');

            // Desc
            let descriptionText = "";
            if (txtFile) {
                try {
                    descriptionText = await fetchDataverseFileContent(txtFile.id, 'text');
                } catch (e) { }
            }

            // MTL
            if (mtlFile) {
                try {
                    const mtlContent = await fetchDataverseFileContent(mtlFile.id, 'text');
                    const mtlLoader = new MTLLoader();
                    originalMaterials = mtlLoader.parse(mtlContent);
                    originalMaterials.preload();
                } catch (e) { }
            }

            // TEX
            let textureDataURL = null;
            if (texFile) {
                try {
                    const arrayBuffer = await fetchDataverseFileContent(texFile.id, 'arraybuffer');
                    const mimeType = texFile.contentType || (texFile.filename.toLowerCase().endsWith('.png') ? 'image/png' : 'image/jpeg');
                    const blob = new Blob([arrayBuffer], { type: mimeType });
                    textureDataURL = URL.createObjectURL(blob);

                    await new Promise((resolve) => {
                        const texLoader = new THREE.TextureLoader();
                        customTexture = texLoader.load(textureDataURL, (tex) => {
                            tex.colorSpace = THREE.SRGBColorSpace;
                            customTexturedMaterial = new THREE.MeshStandardMaterial({
                                map: tex, color: 0xffffff, roughness: 0.6, metalness: 0.1, side: THREE.DoubleSide
                            });
                            resolve();
                        });
                    });
                } catch (e) { }
            }

            // Load Obj
            const loader = new OBJLoader();
            if (originalMaterials && !customTexturedMaterial) {
                loader.setMaterials(originalMaterials);
            }

            loadedObject = loader.parse(objContent);

            // Center & Scale
            const box = new THREE.Box3().setFromObject(loadedObject);
            const size = box.getSize(new THREE.Vector3());
            const center = box.getCenter(new THREE.Vector3());
            const maxDim = Math.max(size.x, size.y, size.z);
            const scaleFactor = 4 / maxDim; // Adjusted scale for this new view

            loadedObject.position.set(-center.x * scaleFactor, -center.y * scaleFactor, -center.z * scaleFactor);
            loadedObject.scale.set(scaleFactor, scaleFactor, scaleFactor);

            // Store Materials
            loadedObject.traverse((child) => {
                if (child.isMesh) {
                    if (customTexturedMaterial) child.originalMaterial = customTexturedMaterial;
                    else if (originalMaterials) child.originalMaterial = child.material;
                    else child.originalMaterial = shadedMaterial.clone();
                }
            });

            scene.add(loadedObject);
            loadedObject.name = fileName;
            loadedObject.descriptionText = descriptionText;
            loadedObject.textureDataURL = textureDataURL;

            // Reset UI Inputs
            document.querySelector('input[name="material"][value="detail"]').checked = true;
            document.querySelector('input[name="mesh"][value="solid"]').checked = true;

            updateObjectMaterial();
            updateDescription(loadedObject, fileName, descriptionText, null, textureDataURL);
        }

        function updateObjectMaterial(forceMsg = false) {
            const strings = UI_STRINGS[currentLang];
            if (!loadedObject) return;

            const matValue = document.querySelector('input[name="material"]:checked').value;
            const meshValue = document.querySelector('input[name="mesh"]:checked').value;
            isWireframe = (meshValue === 'wireframe');

            let targetMat = null;

            if (matValue === 'detail') {
                targetMat = normalMaterial;
                directionalLight.visible = false;
                if (forceMsg) showToast(strings.msgDetail);
            } else if (matValue === 'shaded') {
                targetMat = shadedMaterial;
                directionalLight.visible = true;
                if (forceMsg) showToast(strings.msgShaded);
            } else if (matValue === 'original') {
                directionalLight.visible = true;
                if (customTexturedMaterial || originalMaterials) {
                    if (forceMsg) showToast(strings.msgOriginal);
                } else {
                    showToast(strings.msgErrOriginal, true);
                    document.querySelector('input[name="material"][value="shaded"]').checked = true;
                    targetMat = shadedMaterial;
                }
            }

            loadedObject.traverse((child) => {
                if (child.isMesh) {
                    if (matValue === 'original' && (customTexturedMaterial || originalMaterials)) {
                        child.material = child.originalMaterial;
                        if (Array.isArray(child.material)) child.material.forEach(m => { m.wireframe = isWireframe; m.needsUpdate = true; });
                        else { child.material.wireframe = isWireframe; child.material.needsUpdate = true; }
                    } else if (targetMat) {
                        child.material = targetMat;
                        targetMat.wireframe = isWireframe;
                        targetMat.needsUpdate = true;
                    }
                }
            });
        }

        function updateDescription(obj, fileName, descriptionText, errorMsg, textureDataURL) {
            const strings = UI_STRINGS[currentLang];
            const statsContainer = document.getElementById('stats-container');
            const descEl = document.getElementById('object-description');

            if (!obj) {
                statsContainer.innerHTML = '';
                descEl.innerHTML = `<span class="italic text-slate-400">${strings.descPlaceholder}</span>`;
                return;
            }

            let meshCount = 0, vertexCount = 0, faceCount = 0;
            obj.traverse(child => {
                if (child.isMesh) {
                    meshCount++;
                    vertexCount += child.geometry.attributes.position.count;
                    faceCount += (child.geometry.index ? child.geometry.index.count : child.geometry.attributes.position.count) / 3;
                }
            });

            const mtlStatus = originalMaterials ? strings.statusYesMtl : strings.statusNoMtl;
            const texStatus = textureDataURL ? strings.statusYesTex : strings.statusNoTex;

            // Helper for Stat Card
            const createStatCard = (label, value, icon, colorClass = "text-primary") => `
                <div class="bg-slate-50 dark:bg-[#151c2a] p-3 rounded-lg border border-slate-200 dark:border-slate-700/50 flex items-start gap-3 transition-all hover:border-primary/30 h-full">
                    <div class="size-8 rounded-full bg-white dark:bg-[#1a2436] flex items-center justify-center shrink-0 border border-slate-200 dark:border-slate-700 shadow-sm mt-0.5">
                        <span class="material-symbols-outlined text-[16px] ${colorClass}">${icon}</span>
                    </div>
                    <div class="flex flex-col min-w-0">
                        <span class="text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-slate-500 break-words leading-tight">
                            ${label}
                        </span>
                        <span class="text-sm font-bold text-slate-700 dark:text-slate-200 break-words leading-snug">
                            ${value}
                        </span>
                    </div>
                </div>
             `;

            statsContainer.innerHTML = `
                ${createStatCard(strings.fieldName, fileName, 'draft', 'text-blue-500')}
                ${createStatCard(strings.fieldMeshes, meshCount, 'dataset', 'text-violet-500')}
                ${createStatCard(strings.fieldVertices, vertexCount.toLocaleString(), 'grain', 'text-emerald-500')}
                ${createStatCard(strings.fieldTriangles, Math.round(faceCount).toLocaleString(), 'change_history', 'text-amber-500')}
                ${createStatCard(strings.fieldMtlLoaded, mtlStatus, 'palette', 'text-pink-500')}
                ${createStatCard(strings.fieldTexLoaded, texStatus, 'texture', 'text-cyan-500')}
             `;

            if (descriptionText) {
                // Convert newlines to breaks to preserve paragraph structure
                descEl.innerHTML = descriptionText.replace(/\n/g, '<br>');
            } else {
                descEl.innerHTML = `<span class="italic text-slate-400 text-xs">No description available for this object.</span>`;
            }
        }

        // Init
        window.onload = init;

    </script>
</body>

</html>
